<template name="scenebuilderBuild">
  <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900|Open+Sans:300,400,600,700,800" rel="stylesheet">
  <div class="scenebuilder {{#if editorOpen}}editor-open{{/if}}">
    <div class="scenebuilder__set" data-battlemap="1">
      <div class="set__stage"></div>
      <div class="set__props">
        <div class="set__prop set__prop--1"></div>
        <div class="set__prop set__prop--2"></div>
      </div>
    </div>
    {{#if Template.subscriptionsReady}}
    {{> scenebuilderBuild__stage field=field}}

    {{> scenebuilderBuild__player player=player1}}
    {{> scenebuilderBuild__player player=player2}}
    {{/if}}
  </div>
  {{#if Template.subscriptionsReady}}
  {{> scenebuilderBuild__editor editorOpen=editorContext galleryContext=galleryContext}}
  {{/if}}
</template>

<template name="scenebuilderBuild__player">
  <div class="scenebuilder__player" data-player="{{player.id}}">
    <div class="player__general" data-general="{{player.general.id}}" data-health="{{player.general.health}}" style="background-image: url('/assets/img/scene/generals/hex/hex_{{player.general.id}}.png');"></div>
    <div class="player__general-bbs" data-manacost="{{generalBBS.manaCost}}" data-cooldown="{{player.bbs.cooldown}}" data-remaining="{{player.bbs.remaining}}">
      <span class="bbs__cooldown" data-remaining="{{player.bbs.remaining}}"></span>
      <div class="sprite id_{{generalBBS.id}} passive"></div>
    </div>
    <div class="player__name">{{player.name}}</div>
    <div class="player__manabar" data-available="{{player.manabar.available}}" data-used="{{player.manabar.used}}">
      {{#each playerManaslots}}
      <div class="manabar__manaslot {{#if this.active}}available{{/if}} {{#if this.used}}used{{/if}}">
  			<div class="manaslot__state inactive"></div>
  			<div class="manaslot__state available"></div>
  			<div class="manaslot__state used"></div>
  		</div>
      {{/each}}
    </div>
    <div class="player__summary">
      <div class="summary__mana">
        <div class="mana__label"></div>
        <div class="mana__count">
          <span class="count--remaining count">{{manaRemaining}}</span>
          <span class="count--available">/{{player.manabar.available}}</span>
        </div>
      </div>
      <div class="summary__hand">
        <div class="hand__label">Hand</div>
        <div class="hand__count"><span class="in-hand count">{{player.hand}}</span>/6</div>
      </div>
      <div class="summary__deck">
        <div class="deck__label">Deck</div>
        <div class="deck__count"><span class="in-deck count">{{player.deck.remaining}}</span>/<span class="deck-total">{{player.deck.total}}</span></div>
      </div>
    </div>
    <div class="player__general-artifacts">
      {{#each player.artifacts}}
      <div class="general-artifact opens-editor" data-editor="artifact-slot" data-durability="{{this.durability}}">
        {{#if this.id}}
        {{loadCurrentArtifact}}
        <div class="sprite id_{{this.id}} passive"></div>
        <div class="general-artifact__durability">
          <img src="/assets/img/scene/generals/components/artifact_durability.png" class="durability-indicator">
          <img src="/assets/img/scene/generals/components/artifact_durability.png" class="durability-indicator">
          <img src="/assets/img/scene/generals/components/artifact_durability.png" class="durability-indicator">
        </div>
        {{/if}}
      </div>
      {{/each}}
    </div>
    <div class="player__actionbar">
      {{#each player.actionbar}}
      <div class="actionbar__card {{#if this.id}}has-card{{/if}}" data-manacost="{{#if currentCard}}{{currentCard.manaCost}}{{/if}}" data-type="{{#if currentCard}}{{currentCard.type}}{{/if}}">
        {{#if this.id}}
        <div class="sprite id_{{this.id}} idle breath breathe breathing passive"></div>
        {{/if}}
      </div>
      {{/each}}
    </div>
    <div class="player__deck">
      <div class="deck--active"></div>
    </div>
  </div>
</template>

<template name="scenebuilderBuild__stage">
  <div class="scenebuilder__stage">
    <div class="stage__board">
      {{#each field}}
      <div class="board__row">
        {{#each this}}
        <div class="board-square opens-editor" data-row="{{this.row}}" data-column="{{this.column}}" data-editor="board-tile">
          {{#if this.unit}}
          <div class="tile-drag-unit"></div>
          {{/if}}
        </div>
        {{/each}}
      </div>
      {{/each}}
    </div>
    <div class="scenebuilder__tiles">
      <div class="tiles__floors">
        {{#each field}}
        <div class="floors__row">
          {{#each this}}
          {{#if this.floor}}
          {{#with this.floor}}
          <div class="floor" data-player="{{this.owner}}">
            <div class="tile-object sprite {{this.type}}"></div>
          </div>
          {{/with}}
          {{else}}
          <div class="floor"></div>
          {{/if}}
          {{/each}}
        </div>
        {{/each}}
      </div>
      <div class="tiles__units">
        {{#each field}}
        <div class="units__row">
          {{#each this}}
          {{#if this.unit}}
          {{#with this.unit}}
          <div class="unit" data-attack="{{currentUnit.attack}}" data-health="{{currentUnit.health}}" data-player="{{this.owner}}">
            {{#if draggingUnit}}
            <div class="tile-object sprite id_{{draggingUnit.id}} dragged-unit-sprite idle" data-player="{{draggingUnit.owner}}"></div>
            {{/if}}
            <div class="tile-object sprite id_{{currentUnit.id}} idle"></div>
          </div>
          {{/with}}
          {{else}}
          <div class="unit">
            {{#if draggingUnit}}
            <div class="tile-object sprite id_{{draggingUnit.id}} dragged-unit-sprite idle" data-player="{{draggingUnit.owner}}"></div>
            {{/if}}
          </div>
          {{/if}}
          {{/each}}
        </div>
        {{/each}}
      </div>
    </div>
  </div>
</template>

<template name="scenebuilderBuild__editor">
  <div class="scenebuilder__editor-modal {{#if editorOpen}}editor-open{{/if}} {{#if cardGalleryOpen}}card-gallery-open{{/if}}">

    <div class="editor__contents">
      {{#if editingArtifactSlot}}
      <div class="scenebuilder__editor--artifact-slot">
        <div class="edit-options">
          <button class="btn left-edge condensed">
            <span class="btn_text"><i class="fa fa-trash"></i></span>
          </button>
          <button class="btn">
            <span class="btn_text opens-card-gallery">Change Artifact</span>
          </button>
        </div>
        {{#if currentUnit}}
        {{> databaseCard info=currentUnit layout="dynamicCard"}}
        {{else}}
        <div>{{> databaseCard layout="blankCard" info="Artifact"}}</div>
        {{/if}}
        <div class="btn-bar">
          <button class="btn left-edge closes-editor">
            <span class="btn_text">Cancel</span>
          </button>
          <button class="btn right-edge editor__save-artifact">
            <span class="btn_text">Save</span>
          </button>
        </div>
      </div>
      {{/if}}

      {{#if editingBoardTile}}
      <div class="scenebuilder__editor--board-tile">
        {{#if context.unit}}
        {{#with context.unit}}

        {{#if isGeneral}}
        <div class="edit-options">
          <button class="btn left-edge opens-card-gallery">
            <span class="btn_text">Change General</span>
          </button>
        </div>
        {{> databaseCard info=currentUnit layout="dynamicCard"}}
        <div class="edit-form-group">
          <div class="form-group__row">
            <div class="form-group__input">
              <label for="edit-general__health">Attack</label>
              <input type="text" id="edit-general__attack" name="edit-general__attack" value="{{currentUnit_attack}}">
            </div>
            <div class="form-group__input">
              <label for="edit-general__health">Health</label>
              <input type="text" id="edit-general__health" name="edit-general__health" value="{{currentUnit_health}}">
            </div>
          </div>
        </div>
        <div class="btn-bar">
          <button class="btn left-edge closes-editor">
            <span class="btn_text">Cancel</span>
          </button>
          <button class="btn right-edge editor__save-general">
            <span class="btn_text">Save</span>
          </button>
        </div>
        {{else}}
        {{> databaseCard info=currentUnit}}
        {{/if}}

        {{/with}}
        {{/if}}
      </div>
      {{/if}}

      <button class="editor-closer closes-editor"></button>
    </div>

    <div class="scenebuilder__card-gallery">
      <div class="card-gallery__contents">
        {{#if galleryContext}}
        {{#each galleryContext}}
        <div class="editor__change-card">{{> databaseCard info=this}}</div>
        {{/each}}
        {{/if}}
      </div>
    </div>
  </div>
</template>
